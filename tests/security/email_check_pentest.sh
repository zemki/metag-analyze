#!/bin/bash

###############################################################################
# Email Check API Security Penetration Testing Script
#
# This script performs various security tests on the /api/check-email endpoint
#
# Usage: ./email_check_pentest.sh <base_url> <mart_project_id> <non_mart_project_id>
# Example: ./email_check_pentest.sh http://localhost:8000 1 2
###############################################################################

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check arguments
if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <base_url> <mart_project_id> <non_mart_project_id>"
    echo "Example: $0 http://localhost:8000 1 2"
    exit 1
fi

BASE_URL="$1"
MART_PROJECT_ID="$2"
NON_MART_PROJECT_ID="$3"
ENDPOINT="${BASE_URL}/api/check-email"

# Results tracking
PASSED=0
FAILED=0
WARNINGS=0

# Helper functions
print_header() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}\n"
}

print_test() {
    echo -e "${YELLOW}→ Testing:${NC} $1"
}

print_pass() {
    echo -e "  ${GREEN}✓ PASS:${NC} $1"
    ((PASSED++))
}

print_fail() {
    echo -e "  ${RED}✗ FAIL:${NC} $1"
    ((FAILED++))
}

print_warning() {
    echo -e "  ${YELLOW}⚠ WARNING:${NC} $1"
    ((WARNINGS++))
}

# Test function
test_request() {
    local description="$1"
    local email="$2"
    local project_id="$3"
    local expected_status="$4"

    print_test "$description"

    response=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT" \
        -H "Content-Type: application/json" \
        -d "{\"email\": \"$email\", \"project_id\": $project_id}")

    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n-1)

    if [ "$http_code" == "$expected_status" ]; then
        print_pass "Got expected status $expected_status"
    else
        print_fail "Expected $expected_status, got $http_code"
        echo "  Response: $body"
    fi

    sleep 0.5  # Small delay between requests
}

###############################################################################
# Test Suite
###############################################################################

print_header "1. Rate Limiting Tests"

print_test "Rate limit enforcement (rapid requests)"
rate_limit_hit=false
success_count=0

for i in {1..10}; do
    response=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT" \
        -H "Content-Type: application/json" \
        -d "{\"email\": \"ratelimit${i}@example.com\", \"project_id\": $MART_PROJECT_ID}")

    http_code=$(echo "$response" | tail -n1)

    if [ "$http_code" == "200" ]; then
        ((success_count++))
    elif [ "$http_code" == "429" ]; then
        rate_limit_hit=true
        break
    fi
done

if [ "$rate_limit_hit" = true ]; then
    print_pass "Rate limit triggered after $success_count requests"
else
    print_fail "Rate limit not triggered after 10 requests"
fi

# Wait for rate limit to reset
echo "  Waiting 60 seconds for rate limit reset..."
sleep 60

###############################################################################
print_header "2. SQL Injection Tests"

test_request "SQL Injection - Basic OR" \
    "admin@example.com' OR '1'='1" \
    "$MART_PROJECT_ID" \
    "422"

test_request "SQL Injection - DROP TABLE" \
    "admin@example.com'; DROP TABLE users; --" \
    "$MART_PROJECT_ID" \
    "422"

test_request "SQL Injection - UNION SELECT" \
    "admin@example.com' UNION SELECT * FROM users --" \
    "$MART_PROJECT_ID" \
    "422"

test_request "SQL Injection in project_id" \
    "test@example.com" \
    "1 OR 1=1" \
    "422"

###############################################################################
print_header "3. XSS Injection Tests"

test_request "XSS - Script tag" \
    "<script>alert('XSS')</script>@example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "XSS - IMG tag" \
    "<img src=x onerror=alert(1)>@example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "XSS - SVG tag" \
    "<svg/onload=alert(1)>@example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "XSS - JavaScript protocol" \
    "javascript:alert(1)@example.com" \
    "$MART_PROJECT_ID" \
    "422"

###############################################################################
print_header "4. Command Injection Tests"

test_request "Command Injection - rm command" \
    "test@example.com; rm -rf /" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Command Injection - pipe" \
    "test@example.com | cat /etc/passwd" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Command Injection - whoami" \
    "test@example.com && whoami" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Command Injection - backticks" \
    "test@example.com\`whoami\`" \
    "$MART_PROJECT_ID" \
    "422"

###############################################################################
print_header "5. Email Header Injection Tests"

test_request "Header Injection - newline" \
    "test@example.com\nBcc: attacker@evil.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Header Injection - carriage return" \
    "test@example.com\rBcc: attacker@evil.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Header Injection - URL encoded" \
    "test@example.com%0aBcc: attacker@evil.com" \
    "$MART_PROJECT_ID" \
    "422"

###############################################################################
print_header "6. MART Project Validation Tests"

test_request "Non-MART project rejection" \
    "test@example.com" \
    "$NON_MART_PROJECT_ID" \
    "403"

test_request "Non-existent project" \
    "test@example.com" \
    "99999" \
    "422"

test_request "Invalid project_id type" \
    "test@example.com" \
    "'abc'" \
    "422"

###############################################################################
print_header "7. Input Validation Tests"

test_request "Invalid email - no @" \
    "notanemail" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Invalid email - no domain" \
    "test@" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Invalid email - double @" \
    "test@@example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Invalid email - spaces" \
    "test @example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Extremely long email" \
    "$(printf 'a%.0s' {1..250})@example.com" \
    "$MART_PROJECT_ID" \
    "422"

###############################################################################
print_header "8. Unicode and Encoding Tests"

test_request "Unicode - Cyrillic e" \
    "test@еxample.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Unicode - Full-width @" \
    "test＠example.com" \
    "$MART_PROJECT_ID" \
    "422"

test_request "Null byte injection" \
    "test@example.com\0" \
    "$MART_PROJECT_ID" \
    "422"

###############################################################################
print_header "9. Missing Parameters Tests"

print_test "Missing email parameter"
response=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT" \
    -H "Content-Type: application/json" \
    -d "{\"project_id\": $MART_PROJECT_ID}")

http_code=$(echo "$response" | tail -n1)
if [ "$http_code" == "422" ]; then
    print_pass "Missing email rejected with 422"
else
    print_fail "Expected 422, got $http_code"
fi

print_test "Missing project_id parameter"
response=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT" \
    -H "Content-Type: application/json" \
    -d "{\"email\": \"test@example.com\"}")

http_code=$(echo "$response" | tail -n1)
if [ "$http_code" == "422" ]; then
    print_pass "Missing project_id rejected with 422"
else
    print_fail "Expected 422, got $http_code"
fi

###############################################################################
print_header "10. Timing Attack Tests"

print_test "Measuring response time variance"

times=()
for i in {1..10}; do
    start=$(date +%s%N)
    response=$(curl -s -X POST "$ENDPOINT" \
        -H "Content-Type: application/json" \
        -d "{\"email\": \"timing${i}@example.com\", \"project_id\": $MART_PROJECT_ID}")
    end=$(date +%s%N)

    duration=$(echo "scale=3; ($end - $start) / 1000000" | bc)
    times+=($duration)

    sleep 0.5
done

# Calculate average and check variance
total=0
for time in "${times[@]}"; do
    total=$(echo "$total + $time" | bc)
done
avg=$(echo "scale=3; $total / ${#times[@]}" | bc)

# Check if there's significant variance (random delay working)
min=${times[0]}
max=${times[0]}
for time in "${times[@]}"; do
    if (( $(echo "$time < $min" | bc -l) )); then
        min=$time
    fi
    if (( $(echo "$time > $max" | bc -l) )); then
        max=$time
    fi
done

variance=$(echo "$max - $min" | bc)

echo "  Average response time: ${avg}ms"
echo "  Min: ${min}ms, Max: ${max}ms, Variance: ${variance}ms"

if (( $(echo "$variance > 10" | bc -l) )); then
    print_pass "Significant response time variance (${variance}ms) - timing attack protection active"
else
    print_warning "Low variance (${variance}ms) - timing attack may be possible"
fi

###############################################################################
print_header "11. CORS and Header Tests"

print_test "CORS headers check"
response=$(curl -s -I -X OPTIONS "$ENDPOINT" \
    -H "Origin: https://evil.com" \
    -H "Access-Control-Request-Method: POST")

if echo "$response" | grep -q "Access-Control-Allow-Origin"; then
    print_warning "CORS headers present - verify configuration"
else
    print_pass "No CORS headers in OPTIONS response"
fi

###############################################################################
print_header "12. Valid Request Test (Baseline)"

test_request "Valid request with MART project" \
    "valid@example.com" \
    "$MART_PROJECT_ID" \
    "200"

###############################################################################
# Summary
###############################################################################

print_header "Test Results Summary"

total=$((PASSED + FAILED + WARNINGS))

echo -e "${GREEN}Passed:${NC}   $PASSED / $total"
echo -e "${RED}Failed:${NC}   $FAILED / $total"
echo -e "${YELLOW}Warnings:${NC} $WARNINGS / $total"

if [ $FAILED -eq 0 ]; then
    echo -e "\n${GREEN}✓ All security tests passed!${NC}"
    exit 0
else
    echo -e "\n${RED}✗ Some security tests failed. Review the output above.${NC}"
    exit 1
fi
